{
  "hash": "9881457f72e5f6a067aa1beb90476f7d",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Distributions of Exposures\"\nauthor: \"Samer Mouksassi\"\ndate: \"2025-09-01\"\ncategories: [visualization, distributions]\nimage: \"erdist.png\"\nexecute:\n  fig-device: ragg_png\nformat:\n html:\n  code-fold: true\n---\n\nIn this post, I will cover visualizing the exposure distributions with more details. The [blog post](https://smouksassi.github.io/posts/erplots/ \"Visualizing Dose Exposure Response\") that covered binary response outcomes showed how we often show the distributions of exposures by dose level or study arm, and what interesting summaries we might want to add to it. Keep in mind that we give a dose to a patient and we don't fully control the resulting exposure. That is because, even when we use the same dose level, different patients would achieve different exposures given that they have different body weights, different metabolism and different physiological characteristics. In today's post, I will reuse the same binary logistic data and incrementally add info to this plot, each time giving the rationale behind what we are trying to do. First, we compute the quartiles of exposure across all dose levels (without Placebo) and show distribution densities using `ggplot2` `geom_density`, split/facet by Dose colored by Dose and then colored by quartiles. (This feature is supported in `ggplot2` \\> 4.0).\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(ggplot2)\nlibrary(tidyr)\nlibrary(dplyr)\nlibrary(ggquickeda)\nlibrary(patchwork)\nlibrary(ggridges)\nlibrary(ggrepel)\nlibrary(ggdist)\n\nICGI<- read.csv(\"ICGI.csv\")\nICGI$responder <- ifelse(ICGI$ICGI==1,\"responder\",\n                         \"not responder\")\nICGI$DOSE <- as.factor(ICGI$DOSE)\nICGI$DOSE <- factor(ICGI$DOSE,\n                    levels=c(\"0\", \"600\", \"1200\",\"1800\",\"2400\"),\n                    labels=c(\"Placebo\", \"600 mg\", \"1200 mg\",\"1800 mg\",\"2400 mg\"))\n\nAUCquantiles <-   quantile(ICGI$AUC[ICGI$AUC>0],\n                           probs = c(0.25,0.5,0.75))\nq25 <- AUCquantiles[1]\nq50 <- AUCquantiles[2]\nq75 <- AUCquantiles[3]\n\nICGI <- ICGI %>% \n  mutate(AUC_Q = case_when(AUC ==0            ~ \"Placebo\",\n                          AUC <= q25             ~ \"Q1\",\n                          AUC > q25 & AUC <= q50 ~ \"Q2\",\n                          AUC > q50 & AUC <= q75 ~ \"Q3\",\n                          AUC > q75              ~ \"Q4\"))\n\n\nggplot(ICGI ,\n       aes(x= AUC))+\n  geom_density(aes(y=after_stat(scaled), fill = DOSE),alpha=0.2)+\n  geom_rug()+\n  geom_vline(xintercept = AUCquantiles)+\n  facet_grid(DOSE~.,as.table = FALSE,switch=\"y\")+\n  scale_fill_manual(values=c(\"#4682AC\", \n            \"#FDBB2F\", \"#EE3124\", \"#336343\", \"#7059a6\", \"#803333\"))+\n  scale_color_manual(values=c(\"#4682AC\", \n            \"#FDBB2F\", \"#EE3124\", \"#336343\", \"#7059a6\", \"#803333\"))+\n  theme_bw()+\n  theme(strip.background = element_rect(fill = \"#475c6b\"),\n        strip.text.y.left =   element_text(face = \"bold\",\n                                           color = \"white\",angle=0),\n        strip.placement = \"outside\", axis.title.y.left = element_blank())\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-1-1.png){width=672}\n:::\n\n```{.r .cell-code}\nggplot(ICGI %>% \n         filter(DOSE!=\"Placebo\"))+\n  geom_rug(aes(x = AUC,color = AUC_Q ) ,length = unit(0.2,\"cm\"))+\n  geom_density(aes(x = AUC,\n                   group = DOSE,\n                   y=after_stat(scaled),\n                   fill = after_stat(\n                     case_when(x <= q25 ~ \"Q1\",\n                               x > q25 & x <= q50 ~ \"Q2\",\n                               x > q50 & x <= q75 ~ \"Q3\",\n                               x > q75 ~ \"Q4\"))),alpha=0.5)+\n  geom_vline(xintercept = c(q25,q50,q75))+\n  labs(fill=\"Quartiles\",color=\"Quartiles\")+\n  facet_grid(DOSE~.,as.table = FALSE,switch=\"y\")+\n  scale_fill_manual(values=c(\"#4682AC\", \n            \"#FDBB2F\", \"#EE3124\", \"#336343\", \"#7059a6\", \"#803333\"))+\n  scale_color_manual(values=c(\"#4682AC\", \n            \"#FDBB2F\", \"#EE3124\", \"#336343\", \"#7059a6\", \"#803333\"))+\n  theme_bw()+\n  theme(strip.background = element_rect(fill = \"#475c6b\"),\n        strip.text.y.left =   element_text(face = \"bold\",\n                                           color = \"white\",angle=0),\n        strip.placement = \"outside\", axis.title.y.left = element_blank())\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-1-2.png){width=672}\n:::\n:::\n\n\nNext, I use `ggridges` where we put each dose at the y axis and add a \"pooled\" distribution across all doses (without Placebo). Then I also show the quartiles lines (25%, 50% and 75%) for each dose level and pooled. All values for Placebo are naturally zero and as such I omit the distribution for Placebo. The computed quartiles (which were computed earlier) matches those automatically computed by `ggridges`.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(rbind(ICGI %>% \n               filter(AUC>0),\n             ICGI %>%\n               mutate(DOSE= \"(pooled)\") %>% \n               filter(AUC>0)),\n              aes(x = AUC, y = DOSE, fill = DOSE)) +\n  geom_density_ridges(rel_min_height = 0.01,\n                      quantile_lines = TRUE,\n                      jittered_points = TRUE,\n                      position = \"raincloud\",\n                      alpha = 0.4,\n                      scale = 1)+\n  geom_vline(xintercept = AUCquantiles)+\n  guides(fill = guide_legend(reverse = TRUE))+\n  scale_x_continuous(breaks= seq(0,400,50))+\n  theme_bw()+\n  labs(x=\"AUC (µg*h/mL)\",shape =\"\")+\n  scale_fill_manual(values=c(\"#4682AC\", \n            \"#FDBB2F\", \"#EE3124\", \"#336343\", \"#7059a6\", \"#803333\"))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-2-1.png){width=672}\n:::\n:::\n\n\nWhat we want to reason about is how many patients would achieve exposures within quartiles limits at a given dose level ? This would tell us about the probability of achieving exposures below the first quartile (Q1), between Q1 and Q2, between Q2 and Q3 and ≥ Q4. We compute the quantities of interest using `table1` as well as using simple counting by Dose and quartile category.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntable1::table1(~AUC_Q|DOSE,ICGI,overall = FALSE)\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"Rtable1\"><table class=\"Rtable1\">\n<thead>\n<tr>\n<th class='rowlabel firstrow lastrow'></th>\n<th class='firstrow lastrow'><span class='stratlabel'>Placebo<br><span class='stratn'>(N=244)</span></span></th>\n<th class='firstrow lastrow'><span class='stratlabel'>600 mg<br><span class='stratn'>(N=149)</span></span></th>\n<th class='firstrow lastrow'><span class='stratlabel'>1200 mg<br><span class='stratn'>(N=238)</span></span></th>\n<th class='firstrow lastrow'><span class='stratlabel'>1800 mg<br><span class='stratn'>(N=36)</span></span></th>\n<th class='firstrow lastrow'><span class='stratlabel'>2400 mg<br><span class='stratn'>(N=37)</span></span></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td class='rowlabel firstrow'>AUC_Q</td>\n<td class='firstrow'></td>\n<td class='firstrow'></td>\n<td class='firstrow'></td>\n<td class='firstrow'></td>\n<td class='firstrow'></td>\n</tr>\n<tr>\n<td class='rowlabel'>Placebo</td>\n<td>244 (100%)</td>\n<td>0 (0%)</td>\n<td>0 (0%)</td>\n<td>0 (0%)</td>\n<td>0 (0%)</td>\n</tr>\n<tr>\n<td class='rowlabel'>Q1</td>\n<td>0 (0%)</td>\n<td>103 (69.1%)</td>\n<td>12 (5.0%)</td>\n<td>0 (0%)</td>\n<td>0 (0%)</td>\n</tr>\n<tr>\n<td class='rowlabel'>Q2</td>\n<td>0 (0%)</td>\n<td>46 (30.9%)</td>\n<td>67 (28.2%)</td>\n<td>2 (5.6%)</td>\n<td>0 (0%)</td>\n</tr>\n<tr>\n<td class='rowlabel'>Q3</td>\n<td>0 (0%)</td>\n<td>0 (0%)</td>\n<td>106 (44.5%)</td>\n<td>5 (13.9%)</td>\n<td>4 (10.8%)</td>\n</tr>\n<tr>\n<td class='rowlabel lastrow'>Q4</td>\n<td class='lastrow'>0 (0%)</td>\n<td class='lastrow'>0 (0%)</td>\n<td class='lastrow'>53 (22.3%)</td>\n<td class='lastrow'>29 (80.6%)</td>\n<td class='lastrow'>33 (89.2%)</td>\n</tr>\n</tbody>\n</table>\n</div>\n```\n\n:::\n\n```{.r .cell-code}\npercentineachbreakcategory <- ICGI %>% \n  group_by(DOSE) %>% \n  mutate(Ntot= n())%>% \n  group_by(DOSE,AUC_Q) %>% \n  mutate(Ncat=n(),\n         xmed=median(AUC),xmin = min(AUC),\n         xmax = max(AUC), xmean = mean(c(xmin,xmax)))%>% \n  mutate(percentage=Ncat/Ntot)%>% \n  distinct(DOSE,AUC_Q,xmed,xmean, xmin, xmax,Ncat,Ntot,percentage) %>% \n  arrange(DOSE,AUC_Q)\n```\n:::\n\n\nWe then add this information to the ggridges plot using\n`geom_density_ridges_gradient` to color by quartile and using `geom_text` to add the percentages. We also show how to do it using `geom_density` and `facet_grid`.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(ICGI %>% filter(AUC>0),\n       aes(x = AUC, y = DOSE)) +\n  geom_density_ridges_gradient(aes(fill = after_stat(\n    case_when(x <= q25 ~ \"Q1\",\n              x > q25 & x <= q50 ~ \"Q2\",\n              x > q50 & x <= q75 ~ \"Q3\",\n              x > q75 ~ \"Q4\"))),\n    rel_min_height = 0.01,\n    quantile_lines = TRUE,\n    jittered_points = TRUE, alpha = 0.2, scale = 0.9)+\n  geom_vline(xintercept = AUCquantiles)+\n  geom_text_repel(data=percentineachbreakcategory %>% \n                    filter(DOSE!=\"Placebo\"),\n                  aes(label=paste0(\"N =\",Ncat,\"\\n\",round(100*percentage,0),\"%\"),\n                      x=xmean, y =DOSE,size=4,\n                      color = AUC_Q ),vjust=1.2,\n            direction=\"x\",show.legend = FALSE)+\n  guides(fill = guide_legend(reverse = TRUE))+\n  scale_x_continuous(breaks= seq(0,400,50))+\n  theme_bw()+\n  labs(x=\"AUC (µg*h/mL)\",fill =\"\")+\n  scale_fill_manual(values=c(\"#4682AC70\", \"#FDBB2F70\", \"#EE312470\",\n                             \"#33634370\", \"#7059a670\", \"#80333370\"))+\n  scale_color_manual(values=c(\"#4682AC90\", \"#FDBB2F90\", \"#EE312490\",\n                             \"#33634390\", \"#7059a690\", \"#80333390\"))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n\n```{.r .cell-code}\nggplot(ICGI %>% \n         filter(DOSE!=\"Placebo\"))+\n  geom_rug(aes(x = AUC,color = AUC_Q ) ,length = unit(0.2,\"cm\"))+\n  geom_density(aes(x = AUC,\n                   group = DOSE,\n                   y=after_stat(scaled),\n                   fill = after_stat(\n                     case_when(x <= q25 ~ \"Q1\",\n                               x > q25 & x <= q50 ~ \"Q2\",\n                               x > q50 & x <= q75 ~ \"Q3\",\n                               x > q75 ~ \"Q4\"))),alpha=0.3)+\n  geom_text_repel(data=percentineachbreakcategory %>% \n                    filter(DOSE!=\"Placebo\"),\n                  aes(label=paste0(\"N =\",Ncat,\"\\n\",round(100*percentage,0),\"%\"),\n                      x=xmean, y =0,\n                      color = AUC_Q ),direction=\"y\",\n                  show.legend = FALSE)+\n  geom_text(data=percentineachbreakcategory %>% \n              filter(DOSE!=\"Placebo\")%>%\n              ungroup() %>%\n              distinct(DOSE,Ntot),\n            aes(label=paste0(\"N tot = \",Ntot,\"\\n\\n\"),\n                x=300,y=0,\n            ))+\n  geom_vline(xintercept = c(q25,q50,q75))+\n  labs(fill=\"Quartiles\",color=\"Quartiles\")+\n  facet_grid(DOSE~.,as.table = FALSE,switch=\"y\")+\n  scale_fill_manual(values=c(\"#4682AC\", \n                             \"#FDBB2F\", \"#EE3124\", \"#336343\", \"#7059a6\", \"#803333\"))+\n  scale_color_manual(values=c(\"#4682AC\", \n                              \"#FDBB2F\", \"#EE3124\", \"#336343\", \"#7059a6\", \"#803333\"))+\n  theme_bw()+\n  theme(strip.background = element_rect(fill = \"#475c6b\"),\n        strip.text.y.left =   element_text(face = \"bold\",\n                                           color = \"white\",angle=0),\n        strip.placement = \"outside\", axis.title.y.left = element_blank())\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-4-2.png){width=672}\n:::\n:::\n\n\nThe plot above show us the N of patients and percentages by quartile at each dose level. At the 1800 mg dose, 81 % of patients were at the highest quartile versus  89% at the 2400 mg. We can appreciate that there is some saturation going on. For reference I will show again a plot done using `ggresponseexpdist` which automates this process when user specify the `exposure_distribution_percent` option.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nICGIERDATA <- ICGI\nICGIERDATA$Endpoint <- \"ICGI\"\nICGIERDATA$response <- ICGIERDATA$ICGI \n\nggresponseexpdist(data = ICGIERDATA,\nmodel_type = \"logistic\",\nexposure_metrics = c(\"AUC\"),\nexposure_metric_split = \"quartile\",\nN_byexptile_ypos = \"with means\",\nmean_obs_bydose = TRUE,\nmean_obs_bydose_plac = FALSE,\nN_bydose_ypos = \"none\",\nmean_obs_bydose_text_size = 0,\nN_text_size = 3,\nexposure_distribution_percent = \"%\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-5-1.png){width=864}\n:::\n:::\n\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"../../site_libs/table1-1.0/table1_defaults.css\" rel=\"stylesheet\" />\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}