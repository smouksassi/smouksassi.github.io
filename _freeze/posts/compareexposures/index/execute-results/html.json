{
  "hash": "3b72a30260bf0d4e9d52d05ae9707764",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Comparing Exposures with back to back Density/Boxplots\"\nauthor: \"Samer Mouksassi\"\ndate: \"2025-10-16\"\ncategories: [pediatrics, visualization]\nimage: \"backtoback.gif\"\nformat:\n html:\n  code-fold: true\n---\n\nIn this post, I will cover visualizing simulated drug exposures head to head compare using some `ggplot2` tricks. First we use the NHANES body weight (kg), illustrate the effects of taking into account survey weights in the quantile regression showing the 5^th^, 50^th^, and 95^th^ percentiles. I also overlay the simulated demographics (red points).\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(ggplot2)\nlibrary(tidyr)\nlibrary(dplyr)\nlibrary(patchwork)\nlibrary(nhanesgamlss)\nlibrary(gganimate)\n\nfactor.with.units <- function(x, units) {\n  l <- sort(unique(x))\n  y <- factor(x, levels=l, labels=paste(l, units))\n}\n\n\n# note https://cran.r-project.org/web/packages/RNHANES/vignettes/introduction.html\n# RNHANES help in applying survey weights and in downloading NHANES data\n# I am using a bmxdata.csv\n# bmxdata <- nhanes_load_data(\"BMX\", \"2013-2014\", cache = \"./nhanes_data\",\n#                              demographics = TRUE,recode = TRUE)\n\nbmxdata <- read.csv(\"bmxdata.csv\")\npedcov4000 <- read.csv(\"pedcov4000.csv\")  %>% \n         filter(AGEY<=18) %>% \n      mutate(RIAGENDR = ifelse(SEX==\"boys\",\"Male\",\"Female\"))\nggplot(bmxdata %>% \n         filter(RIDAGEYR<=18),aes(RIDAGEYR,BMXWT))+\n  geom_point(aes(alpha=WTMEC2YR/1000) )+\n  geom_quantile(method = \"rqss\",quantiles = c(0.05,0.5,0.95),lambda= 10,\n  aes(weight = WTMEC2YR,col=\"rqss-weighted\"),linewidth=1.5, alpha = 0.6)+\n  geom_quantile(method = \"rqss\",quantiles = c(0.05,0.5,0.95),lambda= 10,\n  aes(col=\"rqss\"),linewidth=1.5, alpha = 0.6)+\n  geom_point(data = pedcov4000,aes(x=AGEY,y = WT),col=\"red\",alpha=0.1)+\n  facet_grid(~RIAGENDR)+\n  labs(x=\"Years\", y =\"Weight (kg)\",color=\"quantile regression\",\n       alpha=\"NHANES Weights\")+\n    scale_color_manual(values=c(\"#093B6D\", \"#EF761B\"))+\n    theme_bw()+\n    theme(strip.placement = \"outside\",\n          strip.text.y.left = element_text(angle=0),\n          strip.background = ggplot2::element_rect(fill = \"#475c6b\"), \n          strip.text = ggplot2::element_text(face = \"bold\", \n                                             color = \"white\"))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-1-1.png){width=864}\n:::\n:::\n\n\nI then plug these demographics into an `mrgsolve` model and simulate flat fixed dose of 150 mg versus a 2 mg/kg dose ( 150 mg for a 75 kg individual). The resulting areas under the curves (AUC's) are compared using boxplots.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(mrgsolve)\n\ncodepedcov <- '\n$PARAM\nKA=0.365, CL = 2, Vc=22,  Vp1 =200  ,Qp1= 4\nWT=75, AGE=18, SEX = 1\n$CMT GUT CENT PER1\n$MAIN\ndouble KAi = KA;\ndouble CLi = CL *pow((WT/75), 0.75)*exp(ETA(1));\ndouble Vci = Vc *pow((WT/75),    1)*exp(ETA(2));\ndouble Vp1i = Vp1 *pow((WT/75),    1);\ndouble Qp1i = Qp1 *pow((WT/75), 0.75);\ndouble Keli  = CLi/Vci    ;\ndouble Kpt1i =Vp1i/Vci    ;\ndouble Ktp1i =Qp1i/Vp1i   ;\n$OMEGA\n0.6\n$OMEGA\n0.6\n\n$ODE\ndxdt_GUT  = -KAi*GUT;\ndxdt_CENT =  KAi*GUT-Kpt1i*CENT-Keli*CENT+Ktp1i*PER1;\ndxdt_PER1 =          Kpt1i*CENT          -Ktp1i*PER1;\n\n$TABLE\ndouble CP    = CENT/ Vci;\ndouble CPER1 = PER1/Vp1i;\n$CAPTURE CP CPER1 CLi\n'\nmodcovpedsim <- mcode(\"codepedcov\", codepedcov)\nidata <- data_frame(ID=1:nrow(pedcov4000),\n                    WT=pedcov4000$WT,\n                    AGE=pedcov4000$AGEY,\n                    SEX=as.double(as.factor(pedcov4000$SEX )),\n                    TRT =1 \n)\nidata2 <- data_frame(ID=1:nrow(pedcov4000),\n                     WT=pedcov4000$WT,\n                     AGE=pedcov4000$AGEY,\n                     SEX=as.double(as.factor(pedcov4000$SEX )),\n                     TRT =2 \n)\nidata <- rbind(idata,idata2)\nrm(idata2)\nev1 <- ev(time=0, amt=150, cmt=1)\ndata.dose <- ev(ev1)\ndata.dose<-as.data.frame(data.dose)\ndata.all<-merge(idata,data.dose)\ndata.all$amt<- ifelse( data.all$TRT==1,150,2*round(data.all$WT,0))\n\noutpedsim<-modcovpedsim %>%\n  data_set(data.all) %>%\n  carry.out(TRT,WT,AGE,SEX,CLi) %>%\n  mrgsim(end=24, delta=1)\noutpedsim<-as.data.frame(outpedsim)\noutpedsim <- outpedsim %>% \n  arrange(ID,time,WT)\n\nout.ped.nca <- outpedsim %>% \n  group_by(ID,TRT,SEX,WT,AGE)%>% \n  summarise (Cmax = max(CP,na.rm = TRUE),\n             Clast= CP[n()],\n             AUC= sum(diff(time ) *na.omit(lead(CP) + CP)) / 2,\n             CLi= median(CLi)) \n\nout.ped.nca$TRTC <- ifelse(out.ped.nca$TRT==1,\"fixed Dose\",\"perkg Dose\")\nout.ped.nca$WTC <- cut(out.ped.nca$WT,breaks = c(15,30,45,60,125))\nout.ped.nca$`Weight Category`  <- factor.with.units(out.ped.nca$WTC, \"{kg}\")\n\nout.ped.nca$REGIMEN <-  \"a.BASE\"\nggplot(out.ped.nca, aes(x=`Weight Category`, AUC))+\n  annotate(geom=\"rect\",xmin=-Inf,xmax=Inf,ymin=0.25,ymax=1.5,alpha=0.1,fill=\"blue\")+\n  geom_boxplot(aes(fill=TRTC,color = TRTC))+\n  facet_grid(REGIMEN~`Weight Category`,\n             labeller = labeller(`Weight Category`= label_value,\n                                 REGIMEN = label_value),scales=\"free\")+\n  theme_bw()+\n  theme(axis.text.x = element_blank(),legend.position=\"bottom\",\n        axis.ticks.x=element_blank(),\n        strip.text=element_text(size=12),\n        plot.title = element_text(size=14),\n        axis.text.y=element_text(size=12),axis.title.y = element_text(size=16))+\n  guides(color=guide_legend(reverse=TRUE),fill=guide_legend(reverse=TRUE))+\n  theme(strip.background = ggplot2::element_rect(fill = \"#475c6b\"), \n        strip.text = ggplot2::element_text(face = \"bold\", \n                                           color = \"white\"))+\n  scale_color_manual(values=c(\"#093B6D\", \"#EF761B\"))+\n  scale_fill_manual(values=alpha(c(\"#093B6D\", \"#EF761B\"),0.5)) +\n  labs(y=\"Area Under the Curve (mg*h/mL)\",x=\"\")+\n  coord_trans(y = \"log\")+\n  guides(color=guide_legend(reverse=TRUE),\n         fill=guide_legend(reverse=TRUE))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-2-1.png){width=864}\n:::\n:::\n\n\nIdeally we want to keep what we compare close together i.e. the fixed Dose exposures next to the perKg Dose as shown in the second plot above. As a pharmacometrician, I like to see the distribution not just the boxplot so I come up with a hybrid density/boxplot visual below which I will call the **back to back density boxplot**.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstatsdata <- out.ped.nca %>%\n  group_by(TRTC ,WTC,`Weight Category` ) %>%\n  dplyr::summarize(\n    low=quantile(AUC, probs = c(0.05) ),\n    quart=quantile(AUC, probs = c(0.25) ),\n    med=quantile(AUC, probs = c(0.5) ),\n    seven=quantile(AUC, probs = c(0.75) ),\n    up=quantile(AUC, probs = c(0.95) )\n  )\n\nstatsdata$REGIMEN <-\"a.BASE\"\n\nbacktobackhorizontal <- ggplot(out.ped.nca, aes(x = AUC,fill=TRTC ,col=TRTC ),alpha=0.1) +\nfacet_grid(REGIMEN~`Weight Category`,\n           labeller = labeller(`Weight Category`= label_value,\n                               REGIMEN = label_value),scales=\"free_y\")+\n        annotate(geom=\"rect\",\n             ymin=-Inf,ymax=Inf,xmin=0.25,xmax=1.5,alpha=0.1,fill=\"blue\")+\n  stat_density(data=out.ped.nca[out.ped.nca$TRT ==1,],aes(ymax = 0.5*..scaled..,  ymin = rep(0)),\n               colour = \"transparent\",geom = \"ribbon\", position = \"identity\",alpha=0.1) +\n  stat_density(data=out.ped.nca[out.ped.nca$TRT ==2,],aes(ymin = -0.5*..scaled..,  ymax = rep(0)),\n               colour = \"transparent\",geom = \"ribbon\", position = \"identity\",alpha=0.1) +\n  geom_point(data=statsdata[statsdata$TRTC==\"perkg Dose\",]  , aes(x=med),y=-0.1)+\n  geom_point(data=statsdata[statsdata$TRTC!=\"perkg Dose\",]  , aes(x=med),y=0.1)+\n  geom_errorbarh(data=statsdata[statsdata$TRTC ==\"perkg Dose\",]  ,\n                 aes(x=med,y=-0.1,xmax = up, xmin = low),width = 0.1)+\n  geom_errorbarh(data=statsdata[statsdata$TRTC !=\"perkg Dose\",]  ,\n                 aes(x=med,y=0.1,xmax = up, xmin = low),width = 0.1)+\n  geom_errorbarh(data=statsdata[statsdata$TRTC ==\"perkg Dose\",]  ,\n                 aes(x=med,y=-0.1,xmax = seven, xmin = quart),width = 0.15)+\n  geom_errorbarh(data=statsdata[statsdata$TRTC !=\"perkg Dose\",]  ,\n                 aes(x=med,y=0.1,xmax = seven, xmin =quart),width = 0.15)+\n  labs(color=\"\",fill=\"\")\n\nbacktobackhorizontal+\n  coord_flip()+\n  labs(col=\"Dosing Type\",fill=\"Dosing Type\",\n       title=\"Comparing AUC Disributions:\\nFixed versus a Weight-Based Dosing Regimens\")+\n  scale_x_continuous(\"Area Under the Curve (mg*h/mL)\") +\n  ylab(\"\")+ \n  theme_bw()+\n  theme(axis.text.x = element_blank(),legend.position=\"bottom\",\n        axis.ticks.x=element_blank(),\n        strip.text=element_text(size=12),\n        plot.title = element_text(size=14),\n        axis.text.y=element_text(size=12),axis.title.y = element_text(size=16))+\n  guides(color=guide_legend(reverse=TRUE),fill=guide_legend(reverse=TRUE))+\n  theme(strip.background = ggplot2::element_rect(fill = \"#475c6b\"), \n        strip.text = ggplot2::element_text(face = \"bold\", \n                                           color = \"white\"))+\n  scale_color_manual(values=c(\"#093B6D\", \"#EF761B\"))+\n  scale_fill_manual(values=alpha(c(\"#093B6D\", \"#EF761B\"),0.2)) \n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-3-1.png){width=864}\n:::\n:::\n\n\nWe see that the fixed dosing has the densities crossing above the therapeutic range \\[0.25-1.5\\] mg\\*h/mL.\\\nNext, we simulate two fixed dosing strategy reducing the fixed doses by a percentage:\n\n-   **Dose Strategy b:** dose reduced by 80%, 50% and 40 % for the (45,60\\], (30,45\\], and (15,30\\] kg, respectively.\n\n-   **Dose Strategy c:** dose reduced by 75%, 50% and 30 % for the (45,60\\], (30,45\\], and (15,30\\] kg, respectively.\n\nWe compare the outputs using **boxplots:**\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# simulate dose strategy 1 80 % 50 % 40 %\n\nev1 <- ev(time=0,amt=150, cmt=1)\ndata.dose <- ev(ev1)\ndata.dose<-as.data.frame(data.dose)\ndata.all<-merge(idata,data.dose)\ndata.all$amt<- ifelse( data.all$TRT==1,150,2*round(data.all$WT,0))\ndata.all$amt<- ifelse( data.all$TRT==1&data.all$WT<60 ,150*0.8,data.all$amt)\ndata.all$amt<- ifelse( data.all$TRT==1&data.all$WT<45 ,150*0.5,data.all$amt)\ndata.all$amt<- ifelse( data.all$TRT==1&data.all$WT<30 ,150*0.4,data.all$amt)\n\noutpedsim<-modcovpedsim %>%\n  data_set(data.all) %>%\n  carry.out(TRT,WT,AGE,SEX,CLi) %>%\n  mrgsim(end=24, delta=1)\noutpedsim<-as.data.frame(outpedsim)\noutpedsim <- outpedsim %>% \n  arrange(ID,time,WT)\n\nout.ped.nca.1 <- outpedsim %>% \n  group_by(ID,TRT,SEX,WT,AGE)%>% \n  summarise (Cmax = max(CP,na.rm = TRUE),\n             Clast= CP[n()],\n             AUC= sum(diff(time ) *na.omit(lead(CP) + CP)) / 2,\n             CLi= median(CLi)) \nout.ped.nca.1$TRTC <- ifelse(out.ped.nca.1$TRT==1,\"fixed Dose\",\"perkg Dose\")\nout.ped.nca.1$WTC <- cut(out.ped.nca.1$WT,breaks = c(15,30,45,60,125))\nout.ped.nca.1$`Weight Category`  <- factor.with.units(out.ped.nca.1$WTC, \"{kg}\")\n\n\n# simulate dose strategy 2 75 % 50 % 30 %\n\nev1 <- ev(time=0,amt=150, cmt=1)\ndata.dose <- ev(ev1)\ndata.dose<-as.data.frame(data.dose)\ndata.all<-merge(idata,data.dose)\ndata.all$amt<- ifelse( data.all$TRT==1,150,2*round(data.all$WT,0))\ndata.all$amt<- ifelse( data.all$TRT==1&data.all$WT<60 ,150*0.75,data.all$amt)\ndata.all$amt<- ifelse( data.all$TRT==1&data.all$WT<45 ,150*0.5,data.all$amt)\ndata.all$amt<- ifelse( data.all$TRT==1&data.all$WT<30 ,150*0.30,data.all$amt)\n\n\noutpedsim<-modcovpedsim %>%\n  data_set(data.all) %>%\n  carry.out(TRT,WT,AGE,SEX,CLi) %>%\n  mrgsim(end=24, delta=1)\noutpedsim<-as.data.frame(outpedsim)\noutpedsim <- outpedsim %>% \n  arrange(ID,time,WT)\n\nout.ped.nca.2 <- outpedsim %>% \n  group_by(ID,TRT,SEX,WT,AGE)%>% \n  summarise (Cmax = max(CP,na.rm = TRUE),\n             Clast= CP[n()],\n             AUC= sum(diff(time ) *na.omit(lead(CP) + CP)) / 2,\n             CLi= median(CLi)) \nout.ped.nca.2$TRTC <- ifelse(out.ped.nca.2$TRT==1,\"fixed Dose\",\"perkg Dose\")\nout.ped.nca.2$WTC <- cut(out.ped.nca.2$WT,breaks = c(15,30,45,60,125))\nout.ped.nca.2$`Weight Category`  <- factor.with.units(out.ped.nca.2$WTC, \"{kg}\")\n\nstatsdata1 <- out.ped.nca.1 %>%\n  group_by(TRTC ,WTC,`Weight Category` ) %>%\n  dplyr::summarize(\n    low=quantile(AUC, probs = c(0.05) ),\n    quart=quantile(AUC, probs = c(0.25) ),\n    med=quantile(AUC, probs = c(0.5) ),\n    seven=quantile(AUC, probs = c(0.75) ),\n    up=quantile(AUC, probs = c(0.95) )\n  )\n\nstatsdata2 <- out.ped.nca.2 %>%\n  group_by(TRTC ,WTC,`Weight Category` ) %>%\n  dplyr::summarize(\n    low=quantile(AUC, probs = c(0.05) ),\n    quart=quantile(AUC, probs = c(0.25) ),\n    med=quantile(AUC, probs = c(0.5) ),\n    seven=quantile(AUC, probs = c(0.75) ),\n    up=quantile(AUC, probs = c(0.95) )\n  )\nstatsdata1$REGIMEN <-\"b.OPTIMIZED1\"\nstatsdata2$REGIMEN <-\"c.OPTIMIZED2\"\nstatsdata1all <-rbind(statsdata,statsdata1,statsdata2)\n\nout.ped.nca$REGIMEN <-  \"a.BASE\"\nout.ped.nca.1$REGIMEN <-\"b.OPTIMIZED1\"\nout.ped.nca.2$REGIMEN <-\"c.OPTIMIZED2\"\n\nout.ped.nca$WTX <- ifelse(out.ped.nca$`Weight Category`==\"(15,30] {kg}\",(15+30)/2,NA)\nout.ped.nca$WTX <- ifelse(out.ped.nca$`Weight Category`==\"(30,45] {kg}\",(45+30)/2,out.ped.nca$WTX)\nout.ped.nca$WTX <- ifelse(out.ped.nca$`Weight Category`==\"(45,60] {kg}\",(45+60)/2,out.ped.nca$WTX)\nout.ped.nca$WTX <- ifelse(out.ped.nca$`Weight Category`==\"(60,125] {kg}\",(60+125)/2,out.ped.nca$WTX)\n\nout.ped.nca.2$WTX <- ifelse(out.ped.nca.2$`Weight Category`==\"(15,30] {kg}\",(15+30)/2,NA)\nout.ped.nca.2$WTX <- ifelse(out.ped.nca.2$`Weight Category`==\"(30,45] {kg}\",(45+30)/2,out.ped.nca.2$WTX)\nout.ped.nca.2$WTX <- ifelse(out.ped.nca.2$`Weight Category`==\"(45,60] {kg}\",(45+60)/2,out.ped.nca.2$WTX)\nout.ped.nca.2$WTX <- ifelse(out.ped.nca.2$`Weight Category`==\"(60,125] {kg}\",(60+125)/2,out.ped.nca.2$WTX)\nout.ped.nca.1$WTX <- ifelse(out.ped.nca.1$`Weight Category`==\"(15,30] {kg}\",(15+30)/2,NA)\nout.ped.nca.1$WTX <- ifelse(out.ped.nca.1$`Weight Category`==\"(30,45] {kg}\",(45+30)/2,out.ped.nca.1$WTX)\nout.ped.nca.1$WTX <- ifelse(out.ped.nca.1$`Weight Category`==\"(45,60] {kg}\",(45+60)/2,out.ped.nca.1$WTX)\nout.ped.nca.1$WTX <- ifelse(out.ped.nca.1$`Weight Category`==\"(60,125] {kg}\",(60+125)/2,out.ped.nca.1$WTX)\n\n\nout.ped.nca.all <-rbind(out.ped.nca,out.ped.nca.1,out.ped.nca.2)\n\nggplot(out.ped.nca.all, aes(x=`Weight Category`, AUC))+\n  annotate(geom=\"rect\",xmin=-Inf,xmax=Inf,ymin=0.25,ymax=1.5,alpha=0.1,fill=\"blue\")+\n  geom_boxplot(aes(fill=TRTC,color = TRTC))+\n  facet_grid(REGIMEN~`Weight Category`,\n             labeller = labeller(`Weight Category`= label_value,\n                                 REGIMEN = label_value),scales=\"free\")+\n  theme_bw()+\n  theme(axis.text.x = element_blank(),legend.position=\"bottom\",\n        axis.ticks.x=element_blank(),\n        strip.text=element_text(size=12),\n        plot.title = element_text(size=14),\n        axis.text.y=element_text(size=12),axis.title.y = element_text(size=16))+\n  guides(color=guide_legend(reverse=TRUE),fill=guide_legend(reverse=TRUE))+\n  theme(strip.background = ggplot2::element_rect(fill = \"#475c6b\"), \n        strip.text = ggplot2::element_text(face = \"bold\", \n                                           color = \"white\"))+\n  scale_color_manual(values=c(\"#093B6D\", \"#EF761B\"))+\n  scale_fill_manual(values=alpha(c(\"#093B6D\", \"#EF761B\"),0.5)) +\n  labs(y=\"Area Under the Curve (mg*h/mL)\",x=\"\")+\n  coord_trans(y = \"log\")+\n  guides(color=guide_legend(reverse=TRUE),\n         fill=guide_legend(reverse=TRUE))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-4-1.png){width=864}\n:::\n:::\n\n\nWe also re-do the **back to back density boxplot** comparing all three regimens:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbacktobackhorizontalall <- ggplot(out.ped.nca.all, aes(x = AUC,fill=TRTC ,col=TRTC ),alpha=0.1) +\n  annotate(geom=\"rect\",ymin=-Inf,ymax=Inf,xmin=0.25,xmax=1.5,alpha=0.1,fill=\"blue\")+\n  stat_density(data=out.ped.nca.all[out.ped.nca.all$TRT ==1,],aes(ymax = 0.5*..scaled..,  ymin = rep(0)),\n               colour = \"transparent\",geom = \"ribbon\", position = \"identity\",alpha=0.1) +\n  stat_density(data=out.ped.nca.all[out.ped.nca.all$TRT ==2,],aes(ymin = -0.5*..scaled..,  ymax = rep(0)),\n               colour = \"transparent\",geom = \"ribbon\", position = \"identity\",alpha=0.1) +\n  geom_point(data=statsdata1all[statsdata1all$TRTC==\"perkg Dose\",]  , aes(x=med),y=-0.1)+\n  geom_point(data=statsdata1all[statsdata1all$TRTC!=\"perkg Dose\",]  , aes(x=med),y=0.1)+\n  geom_errorbarh(data=statsdata1all[statsdata1all$TRTC ==\"perkg Dose\",]  ,\n                 aes(x=med,y=-0.1,xmax = up, xmin = low),width = 0.1)+\n  geom_errorbarh(data=statsdata1all[statsdata1all$TRTC !=\"perkg Dose\",]  ,\n                 aes(x=med,y=0.1,xmax = up, xmin = low),width = 0.1)+\n  geom_errorbarh(data=statsdata1all[statsdata1all$TRTC ==\"perkg Dose\",]  ,\n                 aes(x=med,y=-0.1,xmax = seven, xmin = quart),width = 0.15)+\n  geom_errorbarh(data=statsdata1all[statsdata1all$TRTC !=\"perkg Dose\",]  ,\n                 aes(x=med,y=0.1,xmax = seven, xmin =quart),width = 0.15)+\n  labs(color=\"\",fill=\"\",y=\"\")+\n  coord_flip()+\n  scale_x_continuous(\"Area Under the Curve (mU*h/mL)\") +\n  labs(col=\"Dosing Type\",fill=\"Dosing Type\",\n       title=\"Comparing AUC Disributions:\\nFixed versus a Weight-Based Dosing Regimens by Weight Category\")+\n  theme(axis.text.x = element_blank(),legend.position=\"bottom\", axis.ticks.x=element_blank(),\n        strip.text=element_text(size=12),\n        plot.title = element_text(size=14),\n        axis.text.y=element_text(size=12),axis.title.y = element_text(size=16))+\n  facet_grid(REGIMEN~`Weight Category`,labeller = labeller(`Weight Category`= label_value,\n                                                           REGIMEN = label_value\n                                                           ),scales=\"free_y\")+\n  guides(color=guide_legend(reverse=TRUE),\n         fill=guide_legend(reverse=TRUE))\nbacktobackhorizontalall+ \n  theme_bw()+\n  theme(axis.text.x = element_blank(),legend.position=\"bottom\",\n        axis.ticks.x=element_blank(),\n        strip.text=element_text(size=12),\n        plot.title = element_text(size=14),\n        axis.text.y=element_text(size=12),axis.title.y = element_text(size=16))+\n  guides(color=guide_legend(reverse=TRUE),fill=guide_legend(reverse=TRUE))+\n  theme(strip.background = ggplot2::element_rect(fill = \"#475c6b\"), \n        strip.text = ggplot2::element_text(face = \"bold\", \n                                           color = \"white\"))+\n  scale_color_manual(values=c(\"#093B6D\", \"#EF761B\"))+\n  scale_fill_manual(values=alpha(c(\"#093B6D\", \"#EF761B\"),0.2)) \n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-5-1.png){width=864}\n:::\n:::\n\n\nAs a bonus, I show how `gganimate` can be used to animate and transition the boxplots across regimens:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlabeldata<- rbind(\n  data.frame(TRTC = c(rep(\"fixed Dose\",4),rep(\"perkg Dose\",4)),\n             x=c((15+30)/2,(45+30)/2,(45+60)/2,(60+125)/2,\n                 (15+30)/2,(45+30)/2,(45+60)/2,(60+125)/2), \n             y = rep(Inf,8),\n             label= c(\"//\",\"//\",\"//\",\"   150 mg   \",\n                      \"//\",\"//\",\"//\",\"   2 mg/kg   \"),\n             REGIMEN = \"a.BASE\"),\n  data.frame(TRTC = c(rep(\"fixed Dose\",4),rep(\"perkg Dose\",4)),\n             x=c((15+30)/2,(45+30)/2,(45+60)/2,(60+125)/2,\n                 (15+30)/2,(45+30)/2,(45+60)/2,(60+125)/2), \n             y = rep(Inf,8),\n             label= c(\"x0.4\",\"x0.5\",\"x0.80\",\"   150 mg   \",\n                      \"//\",\"//\",\"//\",\"   2 mg/kg   \"),\n             REGIMEN = \"b.OPTIMIZED1\" ),\n  data.frame(TRTC = c(rep(\"fixed Dose\",4),rep(\"perkg Dose\",4)),\n             x=c((15+30)/2,(45+30)/2,(45+60)/2,(60+125)/2,\n                 (15+30)/2,(45+30)/2,(45+60)/2,(60+125)/2), \n             y = rep(Inf,8),\n             label= c(\"x0.30\",\"x0.5\",\"x0.75\",\"   150 mg   \",\n                      \"//\",\"//\",\"//\",\"   2 mg/kg   \"),\n             REGIMEN = \"c.OPTIMIZED2\" )\n)\n\nggplot(out.ped.nca.all, aes(WT, AUC,col = TRTC, fill = TRTC))+\n  annotate(geom=\"rect\",xmin=-Inf,xmax=Inf,ymin=0.25,ymax=1.5,alpha=0.1,fill=\"blue\")+\n  geom_vline(data=data.frame(xintercept= c(15,30,45,60) ),\n             aes(xintercept=xintercept) )+\n  geom_boxplot(aes(x=WTX,group=WTX),alpha=0.5)+\n  geom_point(alpha=0.01,size=1)+\n  geom_label(data=labeldata,aes(x,y,label=label),vjust=\"inward\",fill=\"white\",\n             show.legend = FALSE)+\n  facet_grid(REGIMEN~TRTC,labeller=label_value)+\n  scale_x_continuous(breaks=c(15,30,45,60,125))+\n  scale_color_manual(values=c(\"#093B6D\", \"#EF761B\"))+\n  scale_fill_manual(values=alpha(c(\"#093B6D\", \"#EF761B\"),0.2))+\n  labs(x=\"Weight (kg)\",y=\"Area Under the Curve (mg*h/mL)\")+\n  theme_bw()+\n  theme(strip.placement = \"outside\",\n        strip.text.y.left = element_text(angle=0),\n        strip.background = ggplot2::element_rect(fill = \"#475c6b\"), \n        strip.text = ggplot2::element_text(face = \"bold\", \n                                           color = \"white\"),\n        legend.position = \"bottom\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-6-1.png){width=864}\n:::\n:::\n\n\nInstead of facetting by regimen now we use `transition_states(REGIMEN,...`):\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(out.ped.nca.all, aes(WT, AUC,col = TRTC, fill = TRTC))+\n  annotate(geom=\"rect\",xmin=-Inf,xmax=Inf,ymin=0.25,ymax=1.5,alpha=0.1,fill=\"blue\")+\n  geom_vline(data=data.frame(xintercept= c(15,30,45,60) ),aes(xintercept=xintercept) )+\n  geom_boxplot(aes(x=WTX,group=WTX),alpha=0.5)+\n  geom_point(alpha=0.01,size=1)+\n  geom_label(data=labeldata,aes(x,y,label=label),vjust=\"inward\",fill=\"white\")+\n  facet_grid(~TRTC,labeller=label_value)+\n  scale_x_continuous(breaks=c(15,30,45,60,125))+\n  scale_color_manual(values=c(\"#093B6D\", \"#EF761B\"))+\n  scale_fill_manual(values=alpha(c(\"#093B6D\", \"#EF761B\"),0.2))+\n  labs(x=\"Weight (kg)\",y=\"Area Under the Curve (mg*h/mL)\")+\n  theme_bw()+\n  theme(strip.placement = \"outside\",\n        strip.text.y.left = element_text(angle=0),\n        strip.background = ggplot2::element_rect(fill = \"#475c6b\"), \n        strip.text = ggplot2::element_text(face = \"bold\", color = \"white\"),\n        legend.position = \"bottom\")+\n  transition_states(\n    REGIMEN,\n    transition_length = 2,\n    state_length = 1\n  ) +\n  enter_fade() + \n  exit_shrink() +\n  ease_aes('sine-in-out')\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-7-1.gif)\n:::\n\n```{.r .cell-code}\n#anim_save(\"./boxplot.gif\",type=\"cairo-png\")\n```\n:::\n\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}